import { Tool } from '@langchain/core/tools';
import { BaseChatModel } from '@langchain/core/language_models/chat_models';
import { ExtractedVulnerability } from '../../types/sca.types';
import { ForumMessage } from '../../types/sca.types';
import { LLMService } from '../../services/llm.service';

export class VulnerabilityExtractorTool extends Tool {
  name = 'vulnerability_extractor';
  description = 'Extracts vulnerable package information from forum messages using LLM analysis. Input should be JSON array of forum messages. Returns JSON array of vulnerabilities with package name, version range, CVE ID, severity, and description.';

  private llm: BaseChatModel;
  private modelName: string;

  constructor() {
    super();
    this.modelName = process.env.LLM_MODEL || process.env.OLLAMA_CHAT_MODEL || 'llama3:8b';
    this.llm = LLMService.createLLM();
  }

  async _call(input: string): Promise<string> {
    console.log(`[VulnerabilityExtractorTool] üîç Tool called - Input size: ${input.length} chars`);
    const startTime = Date.now();

    try {
      // Parse forum messages
      console.log(`[VulnerabilityExtractorTool] üìã Parsing forum messages from JSON...`);
      const messages: ForumMessage[] = JSON.parse(input);

      if (!Array.isArray(messages) || messages.length === 0) {
        console.log(`[VulnerabilityExtractorTool] ‚ö†Ô∏è  No forum messages provided, returning empty array`);
        return '[]';
      }

      console.log(`[VulnerabilityExtractorTool] üìä Processing ${messages.length} forum message(s) for vulnerability extraction...`);

      const allVulnerabilities: ExtractedVulnerability[] = [];

      // Process each message
      for (let i = 0; i < messages.length; i++) {
        const message = messages[i];
        console.log(`[VulnerabilityExtractorTool] [${i + 1}/${messages.length}] Analyzing message: "${message.title.substring(0, 50)}..."`);
        const messageStart = Date.now();
        const vulnerabilities = await this.extractFromMessage(message);
        const messageDuration = Date.now() - messageStart;
        console.log(`[VulnerabilityExtractorTool] [${i + 1}/${messages.length}] ‚úÖ Extracted ${vulnerabilities.length} vulnerability(ies) in ${messageDuration}ms`);
        allVulnerabilities.push(...vulnerabilities);
      }

      // Deduplicate by package name and CVE ID
      console.log(`[VulnerabilityExtractorTool] üîÑ Deduplicating vulnerabilities...`);
      const unique = this.deduplicateVulnerabilities(allVulnerabilities);
      console.log(`[VulnerabilityExtractorTool] üìä Total unique vulnerabilities: ${unique.length} (from ${allVulnerabilities.length} total)`);

      const result = JSON.stringify(unique, null, 2);
      const totalDuration = Date.now() - startTime;
      console.log(`[VulnerabilityExtractorTool] ‚úÖ Tool completed in ${totalDuration}ms - Returning ${unique.length} unique vulnerability(ies)`);

      return result;
    } catch (error: any) {
      const duration = Date.now() - startTime;
      console.error(`[VulnerabilityExtractorTool] ‚ùå Tool failed after ${duration}ms:`, error.message);
      return `Error extracting vulnerabilities: ${error.message}`;
    }
  }

  private async extractFromMessage(message: ForumMessage): Promise<ExtractedVulnerability[]> {
    console.log(`[VulnerabilityExtractorTool] ü§ñ Preparing LLM prompt for vulnerability extraction...`);
    const prompt = `Analyze the following forum message about security vulnerabilities and extract all mentioned vulnerable packages.

Forum Message:
Title: ${message.title}
Content: ${message.content.substring(0, 10000)}  ${message.content.length > 10000 ? '... [truncated]' : ''}

Extract the following information for each vulnerable package mentioned:
1. Package name (e.g., "express", "lodash", "axios")
2. Version range if mentioned (e.g., "<4.18.0", ">=2.0.0 <2.1.0", "all versions <4.17.21")
3. CVE ID if mentioned (e.g., "CVE-2024-1234", "CVE-2021-23337")
4. Severity if mentioned (critical, high, medium, low)
5. Brief description of the vulnerability

Return the result as a JSON array. Example format:
[
  {
    "packageName": "lodash",
    "versionRange": "<4.17.21",
    "cveId": "CVE-2021-23337",
    "severity": "high",
    "description": "Prototype pollution vulnerability in defaultsDeep function"
  }
]

If no vulnerabilities are found, return an empty array []. Only return valid JSON, no additional text.`;

    try {
      console.log(`[VulnerabilityExtractorTool] ü§ñ Calling LLM (${this.modelName}) for vulnerability extraction...`);
      const llmStart = Date.now();
      const response = await this.llm.invoke(prompt);
      const llmDuration = Date.now() - llmStart;
      const content = typeof response.content === 'string' ? response.content : String(response.content);
      console.log(`[VulnerabilityExtractorTool] ü§ñ LLM response received in ${llmDuration}ms - Response length: ${content.length} chars`);

      // Extract JSON from response (handle cases where LLM adds extra text)
      console.log(`[VulnerabilityExtractorTool] üîç Extracting JSON from LLM response...`);
      const jsonMatch = content.match(/\[[\s\S]*\]/);
      if (!jsonMatch) {
        console.warn(`[VulnerabilityExtractorTool] ‚ö†Ô∏è  No JSON array found in LLM response`);
        return [];
      }

      console.log(`[VulnerabilityExtractorTool] üìã Parsing extracted JSON...`);
      const vulnerabilities: ExtractedVulnerability[] = JSON.parse(jsonMatch[0]);
      console.log(`[VulnerabilityExtractorTool] ‚úÖ Parsed ${vulnerabilities.length} vulnerability(ies) from JSON`);

      // Add source URL to each vulnerability
      const enriched = vulnerabilities.map(vuln => ({
        ...vuln,
        sourceUrl: message.url,
      }));

      console.log(`[VulnerabilityExtractorTool] ‚úÖ Enriched vulnerabilities with source URLs`);
      return enriched;
    } catch (error: any) {
      console.error(`[VulnerabilityExtractorTool] ‚ùå Failed to extract packages:`, error.message);
      return [];
    }
  }

  private deduplicateVulnerabilities(
    vulnerabilities: ExtractedVulnerability[],
  ): ExtractedVulnerability[] {
    const seen = new Map<string, ExtractedVulnerability>();

    for (const vuln of vulnerabilities) {
      const key = `${vuln.packageName.toLowerCase()}_${vuln.cveId || 'no-cve'}`;
      if (!seen.has(key)) {
        seen.set(key, vuln);
      } else {
        // Merge if we have more information
        const existing = seen.get(key)!;
        if (vuln.cveId && !existing.cveId) {
          existing.cveId = vuln.cveId;
        }
        if (vuln.versionRange && !existing.versionRange) {
          existing.versionRange = vuln.versionRange;
        }
        if (vuln.severity && !existing.severity) {
          existing.severity = vuln.severity;
        }
        if (vuln.description && !existing.description) {
          existing.description = vuln.description;
        }
      }
    }

    return Array.from(seen.values());
  }
}

